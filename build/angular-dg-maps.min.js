/**
 * angular-dg-maps.js
 * Simple to use Angular.js component to work with 2GIS Maps API
 * @version v0.0.1 - 2013-07-28
 * @link http://burivuhster.github.io/angular-dg-maps
 * @author Eugene Molodkin <burivuh@gmail.com>
 * @license MIT License, http://www.opensource.org/licenses/MIT
 */
!function(){"use strict";var a=angular.module("dg-maps",[]);a.directive("dgMap",["$log","$timeout","$filter","$rootScope",function(a,b,c,d){return{restrict:"ECA",priority:100,transclude:!0,template:"<div class='angular-dg-map' ng-transclude></div>",replace:!0,scope:{latitude:"=",longitude:"=",zoom:"=",markers:"=",zoomControls:"=",fullscreenControls:"=",fitToMarkers:"=",draggable:"="},link:function(b,c){if(!angular.isDefined(b.zoom))return a.error("angular-dg-maps: map zoom property not set"),void 0;angular.element(c).addClass("angular-dg-map");var e=new DG.Map(c.attr("id"));angular.isDefined(b.latitude)&&angular.isDefined(b.longitude)&&e.setCenter(new DG.GeoPoint(b.longitude,b.latitude),b.zoom);var f=new DG.Controls.Zoom;e.controls.add(f);var g=!1;!angular.isDefined(b.zoomControls)||b.zoomControls?f.show():f.hide(),!angular.isDefined(b.fullscreenControls)||b.fullscreenControls?e.fullscreen.enable():e.fullscreen.disable(),angular.isDefined(b.draggable)&&!b.draggable&&e.disableDragging(),b.addMarker=function(a){if(a.latitude&&a.longitude){var c={geoPoint:new DG.GeoPoint(a.longitude,a.latitude),draggable:!!a.draggable,hint:a.hint||""};a.click&&"function"==typeof a.click&&(c.clickCallback=a.click),a.dragStart&&"function"==typeof a.dragStart&&(c.dragStartCallback=a.dragStart),a.draggable&&(c.dragStopCallback=function(c){var d=c.getPosition();d&&b.$apply(function(){a.latitude=d.lat,a.longitude=d.lon}),a.dragStop&&"function"==typeof a.dragStop&&a.dragStop.apply(this,arguments)});var d=new DG.Markers.Common(c);e.markers.add(d)}},angular.isDefined(b.markers)&&angular.isArray(b.markers)&&b.markers.length&&angular.forEach(b.markers,function(a){b.addMarker(a)}),b.map=e,b.$watch("latitude",function(a,c){a===c||g||e.setCenter(new DG.GeoPoint(b.longitude,a),b.zoom)},!0),b.$watch("longitude",function(a,c){a===c||g||e.setCenter(new DG.GeoPoint(a,b.latitude),b.zoom)},!0),b.$watch("zoom",function(a,b){a===b||g||e.setZoom(a)},!0),b.$watch("zoomControls",function(a,b){a!=b&&(a?f.show():f.hide())}),b.$watch("fullscreenControls",function(a,b){a!=b&&(a?e.fullscreen.enable():e.fullscreen.disable())}),b.$watch("markers",function(a){if(!g&&a&&(e.markers.removeAll(),angular.forEach(b.markers,function(a){b.addMarker(a)}),b.fitToMarkers)){var c=e.markers.getBounds();e.setBounds(c)}},!0),e.addEventListener(e.getContainerId(),"DgZoomChange",function(a){d.$root.$$phase?b.zoom=a.getZoom():b.$apply(function(){b.zoom=a.getZoom()})}),e.addEventListener(e.getContainerId(),"DgMapMove",function(a){var c=a.getCenter();c&&(d.$root.$$phase?(b.latitude=c.lat,b.longitude=c.lon):b.$apply(function(){b.latitude=c.lat,b.longitude=c.lon}))}),e.addEventListener(e.getContainerId(),"DgDragStart",function(){g=!0}),e.addEventListener(e.getContainerId(),"DgDragStop",function(){g=!1})}}}]),a.directive("dgStaticMap",["$log",function(a){return{restrict:"ECA",priority:100,template:"<img class='angular-dg-static-map' ng-src='{{ mapSrc }}'>",replace:!0,scope:{latitude:"=",longitude:"=",zoom:"=",width:"=",height:"=",markers:"="},link:function(b,c){if(!angular.isDefined(b.latitude))return a.error("angular-dg-static-maps: map latitude property not set"),void 0;if(!angular.isDefined(b.longitude))return a.error("angular-dg-static-maps: map longitude property not set"),void 0;if(!angular.isDefined(b.markers)&&!angular.isDefined(b.zoom))return a.error("angular-dg-static-maps: map zoom property not set"),void 0;if(!angular.isDefined(b.width)||!angular.isDefined(b.height))return a.error("angular-dg-static-maps: width and height properties should be set"),void 0;angular.element(c).addClass("angular-dg-static-map");var d="http://static.maps.api.2gis.ru/1.0?";d+="center="+b.longitude+","+b.latitude,d+="&zoom="+b.zoom,d+="&size="+b.width+","+b.height,b.mapSrc=d}}}]),a.service("geocoder",function(){return{get:function(a,b){return DG.Geocoder.get(a,b)}}})}();